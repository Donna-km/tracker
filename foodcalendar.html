<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Food Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .custom-pink { background-color: #FF3974; }
        .custom-cream { background-color: #FFECD0; }
        .custom-pink-text { color: #FF3974; }
        .custom-pink-border { border-color: #FF3974; }
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            transform: scale(1.05);
        }
        .streak-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 5px #FF3974, 0 0 10px #FF3974; }
            to { text-shadow: 0 0 10px #FF3974, 0 0 20px #FF3974; }
        }
    </style>
</head>
<body class="custom-cream min-h-screen">
    <!-- Header -->
    <header class="custom-pink text-white p-4 shadow-lg">
        <div class="max-width-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">üçΩÔ∏è</div>
                <h1 class="text-xl font-bold">Food Tracker</h1>
            </div>
            <div id="userInfo" class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                    <span class="text-sm custom-pink-text font-bold" id="userInitial">D</span>
                </div>
                <span id="userName" class="text-sm">Demo User</span>
            </div>
        </div>
    </header>

    <!-- Today's Summary -->
    <div class="max-w-6xl mx-auto p-4">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold custom-pink-text mb-4">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl mb-2">üçΩÔ∏è</div>
                    <div class="text-sm text-gray-600">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ</div>
                    <div class="text-xl font-bold custom-pink-text" id="todayCalories">0</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl mb-2">üéØ</div>
                    <div class="text-sm text-gray-600">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ TDEE</div>
                    <div class="text-xl font-bold text-gray-700" id="tdeeGoal">0</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl mb-2" id="moodEmoji">üòä</div>
                    <div class="text-sm text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                    <div class="text-sm font-semibold" id="statusText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Streak Counter -->
    <div class="max-w-6xl mx-auto p-4">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex items-center justify-center space-x-3">
                <span class="text-4xl">üî•</span>
                <span class="text-2xl font-bold custom-pink-text streak-glow" id="streakCount">0/0</span>
                <span class="text-lg text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto p-4 grid lg:grid-cols-2 gap-6">
        <!-- Calendar Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold custom-pink-text">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                <div class="flex space-x-2">
                    <button onclick="changeMonth(-1)" class="p-2 custom-pink text-white rounded-lg hover:opacity-80">
                        ‚Üê
                    </button>
                    <button onclick="changeMonth(1)" class="p-2 custom-pink text-white rounded-lg hover:opacity-80">
                        ‚Üí
                    </button>
                </div>
            </div>
            <div id="currentMonth" class="text-center font-semibold mb-4 custom-pink-text"></div>
            <div class="grid grid-cols-7 gap-2 mb-2">
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏≠‡∏≤</div>
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏à</div>
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏≠</div>
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏û</div>
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏û‡∏§</div>
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏®</div>
                <div class="text-center text-sm font-semibold text-gray-600 p-2">‡∏™</div>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold custom-pink-text">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà</h2>
                <select id="chartPeriod" onchange="updateChart()" class="border custom-pink-border rounded-lg px-3 py-1 text-sm">
                    <option value="1w">1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                    <option value="1m">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="3m">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="6m">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="9m">9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="1y">1 ‡∏õ‡∏µ</option>
                </select>
            </div>
            <canvas id="calorieChart" width="400" height="200"></canvas>
        </div>
    </div>





    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App data
        let currentDate = new Date();
        let currentUser = null;
        let foodData = {};
        let chart = null;
        let userTDEE = 2000; // Default value

        // LIFF Integration
        async function initializeLIFF() {
            try {
                if (typeof liff !== 'undefined') {
                    await liff.init({ liffId: "YOUR_LIFF_ID" });
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    
                    const profile = await liff.getProfile();
                    currentUser = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl
                    };
                    
                    updateUserInfo();
                    await loadUserData();
                } else {
                    console.log('LIFF not available, using demo mode');
                    initializeDemoData();
                }
            } catch (error) {
                console.log('LIFF initialization failed, using demo mode:', error);
                initializeDemoData();
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName;
                document.getElementById('userInitial').textContent = currentUser.displayName.charAt(0);
            }
        }

        // Supabase Functions
        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Load user TDEE from tdee_form table
                const { data: tdeeData, error: tdeeError } = await supabaseClient
                    .from('tdee_form')
                    .select('tdee')
                    .eq('line_user_id', currentUser.userId)
                    .single();

                if (tdeeData && !tdeeError) {
                    userTDEE = tdeeData.tdee;
                }

                // Load calorie data from daily_calorie_summary
                const { data: calorieData, error: calorieError } = await supabaseClient
                    .from('daily_calorie_summary')
                    .select('*')
                    .eq('line_user_id', currentUser.userId)
                    .order('date', { ascending: false })
                    .limit(365);

                if (calorieData && !calorieError) {
                    foodData = {};
                    calorieData.forEach(record => {
                        foodData[record.date] = {
                            calories: record.total_calories || 0,
                            goalCalories: record.goal_calories || userTDEE,
                            foods: [] // We'll need another table for individual foods if needed
                        };
                    });
                }

                updateTodaySummary();
                calculateStreak();
                renderCalendar();
                updateChart();

            } catch (error) {
                console.error('Error loading user data:', error);
                initializeDemoData();
            }
        }

        async function saveCalorieData(date, calories) {
            if (!currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('daily_calorie_summary')
                    .upsert({
                        line_user_id: currentUser.userId,
                        date: date,
                        total_calories: calories
                    }, {
                        onConflict: 'line_user_id,date'
                    });

                if (error) {
                    console.error('Error saving calorie data:', error);
                }
            } catch (error) {
                console.error('Error saving to Supabase:', error);
            }
        }

        // Initialize demo data for testing
        function initializeDemoData() {
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const calories = Math.floor(Math.random() * 1000) + 1500;
                foodData[dateStr] = {
                    calories: calories,
                    goalCalories: userTDEE,
                    foods: [
                        { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î', calories: Math.floor(calories * 0.4) },
                        { name: '‡∏™‡πâ‡∏°‡∏ï‡∏≥', calories: Math.floor(calories * 0.3) },
                        { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ', calories: Math.floor(calories * 0.3) }
                    ]
                };
            }
        }

        // Calendar functions
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                `${year} ${new Date(year, month).toLocaleDateString('th-TH', { month: 'long' })}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dateStr = date.toISOString().split('T')[0];
                const dayData = foodData[dateStr];
                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === new Date().toDateString();
                
                let emoji = '';
                let bgColor = 'bg-gray-100';
                
                if (dayData && isCurrentMonth) {
                    const goalCalories = dayData.goalCalories || userTDEE;
                    const percentage = (dayData.calories / goalCalories) * 100;
                    if (percentage < 65) {
                        emoji = 'üò∞';
                        bgColor = 'bg-yellow-100';
                    } else if (percentage <= 85) {
                        emoji = 'üéâ';
                        bgColor = 'bg-green-100';
                    } else if (percentage <= 100) {
                        emoji = 'üòä';
                        bgColor = 'bg-blue-100';
                    } else {
                        emoji = 'üò¢';
                        bgColor = 'bg-red-100';
                    }
                }
                
                if (isToday) {
                    bgColor = 'custom-pink text-white';
                }
                
                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day p-2 text-center rounded-lg cursor-pointer ${bgColor} ${isCurrentMonth ? '' : 'opacity-30'}`;
                dayElement.innerHTML = `
                    <div class="text-sm font-semibold">${date.getDate()}</div>
                    <div class="text-lg">${emoji}</div>
                `;
                
                if (isCurrentMonth) {
                    dayElement.onclick = () => selectDate(dateStr);
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function selectDate(dateStr) {
            const data = foodData[dateStr];
            if (data) {
                const goalCalories = data.goalCalories || userTDEE;
                const message = `${dateStr}\n‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.calories}\n‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${goalCalories}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getStatusText(data.calories, goalCalories)}`;
                
                // Create custom modal instead of alert
                showInfoModal(message);
            }
        }

        function showInfoModal(message) {
            // Create a simple info modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 m-4 max-w-sm w-full">
                    <div class="text-center">
                        <pre class="text-sm text-gray-700 whitespace-pre-wrap">${message}</pre>
                        <button onclick="this.closest('.fixed').remove()" class="mt-4 custom-pink text-white px-4 py-2 rounded-lg hover:opacity-80">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getStatusText(calories, goalCalories) {
            const percentage = (calories / goalCalories) * 100;
            if (percentage < 65) return '‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
            if (percentage <= 85) return '‡∏î‡∏µ‡∏°‡∏≤‡∏Å!';
            if (percentage <= 100) return '‡∏î‡∏µ';
            return '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
        }

        // Chart functions
        function initializeChart() {
            const ctx = document.getElementById('calorieChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ',
                        data: [],
                        borderColor: '#FF3974',
                        backgroundColor: 'rgba(255, 57, 116, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ TDEE',
                        data: [],
                        borderColor: '#FFA500',
                        borderDash: [5, 5],
                        tension: 0
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: Math.max(userTDEE + 500, 2500),
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    animation: false
                }
            });
            updateChart();
        }

        function updateChart() {
            const period = document.getElementById('chartPeriod').value;
            const days = {
                '1w': 7, '1m': 30, '3m': 90, 
                '6m': 180, '9m': 270, '1y': 365
            }[period];
            
            const labels = [];
            const calorieData = [];
            const tdeeData = [];
            
            const today = new Date();
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('th-TH', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                
                const dayData = foodData[dateStr];
                calorieData.push(dayData ? dayData.calories : 0);
                tdeeData.push(dayData ? (dayData.goalCalories || userTDEE) : userTDEE);
            }
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = calorieData;
            chart.data.datasets[1].data = tdeeData;
            chart.update('none');
        }

        // Food management
        function showAddFoodModal() {
            document.getElementById('addFoodModal').classList.remove('hidden');
            document.getElementById('addFoodModal').classList.add('flex');
        }

        function hideAddFoodModal() {
            document.getElementById('addFoodModal').classList.add('hidden');
            document.getElementById('addFoodModal').classList.remove('flex');
            document.getElementById('foodName').value = '';
            document.getElementById('calories').value = '';
        }

        async function addFood(event) {
            event.preventDefault();
            
            const foodName = document.getElementById('foodName').value;
            const calories = parseInt(document.getElementById('calories').value);
            const today = new Date().toISOString().split('T')[0];
            
            if (!foodData[today]) {
                foodData[today] = { 
                    calories: 0, 
                    goalCalories: userTDEE,
                    foods: [] 
                };
            }
            
            foodData[today].foods.push({ name: foodName, calories: calories });
            foodData[today].calories += calories;
            
            // Save to Supabase
            await saveCalorieData(today, foodData[today].calories);
            
            updateTodaySummary();
            renderCalendar();
            updateChart();
            hideAddFoodModal();
        }

        function updateTodaySummary() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = foodData[today] || { calories: 0, goalCalories: userTDEE };
            
            document.getElementById('todayCalories').textContent = todayData.calories.toLocaleString();
            document.getElementById('tdeeGoal').textContent = (todayData.goalCalories || userTDEE).toLocaleString();
            
            const goalCalories = todayData.goalCalories || userTDEE;
            const percentage = (todayData.calories / goalCalories) * 100;
            let emoji, status;
            
            if (percentage < 65) {
                emoji = 'üò∞';
                status = '‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
            } else if (percentage <= 85) {
                emoji = 'üéâ';
                status = '‡∏î‡∏µ‡∏°‡∏≤‡∏Å!';
            } else if (percentage <= 100) {
                emoji = 'üòä';
                status = '‡∏î‡∏µ';
            } else {
                emoji = 'üò¢';
                status = '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
            }
            
            document.getElementById('moodEmoji').textContent = emoji;
            document.getElementById('statusText').textContent = status;
        }

        function calculateStreak() {
            let successDays = 0;
            let totalDays = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayData = foodData[dateStr];
                if (dayData && dayData.calories > 0) {
                    totalDays++;
                    const goalCalories = dayData.goalCalories || userTDEE;
                    const percentage = (dayData.calories / goalCalories) * 100;
                    if (percentage >= 65 && percentage <= 100) {
                        successDays++;
                    }
                }
            }
            
            document.getElementById('streakCount').textContent = `${successDays}/${totalDays}`;
        }

        // Initialize app
        async function initializeApp() {
            await initializeLIFF();
            renderCalendar();
            initializeChart();
            updateTodaySummary();
            calculateStreak();
        }

        // Start the app
        initializeApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fd758865527b4a',t:'MTc2MDY3OTYwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
